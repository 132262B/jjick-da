<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="app.jjickda.api.admin.repository.AdminRepository">

    <insert id="registMain" parameterType="addMainCategoryDto">
        INSERT
          INTO TB_EXAM_MAIN_CATEGORY
             ( MAIN_CATEGORY_NAME
             , USE_STATUS
             , REG_DATE
             , REG_IDX
             )
        VALUES
             ( #{mainQuestion.mainCategoryName}
             , 1
             , now()
             , #{user.idx}
             );
    </insert>

    <insert id="registSub" parameterType="addSubCategoryDto">
        INSERT INTO TB_EXAM_SUB_CATEGORY(
        MAIN_CATEGORY_IDX,
        SUB_CATEGORY_NAME,
        USE_STATUS,
        REG_DATE,
        REG_IDX
        )VALUES(
             #{subQuestion.mainCategoryIdx}
           , #{subQuestion.subCategoryName}
           , 1
           , now()
           , #{user.idx}
        );
    </insert>

    <insert id="registSubject" parameterType="addSubjectDto">
        INSERT INTO TB_EXAM_SUBJECT(
          SUB_CATEGORY_IDX
        , SUBJECT_NAME
        , USE_STATUS
        , REG_DATE
        , REG_IDX
        ) VALUES(
          #{subject.subCategoryIdx}
        , #{subject.subjectName}
        , 1
        , now()
        , #{user.idx}
        );
    </insert>



    <select id="getMainList" resultType="getMainCategoryDto">
        SELECT
        e.MAIN_CATEGORY_NAME,
        e.IDX,
        e.USE_STATUS,
        e.REG_DATE,
        e.REG_IDX,
        e.UDT_DATE,
        e.UDT_IDX,
        u.NAME as regUserName,
        IFNULL(user.NAME,"없음") as udtUserName
        FROM TB_EXAM_MAIN_CATEGORY e
        LEFT JOIN TB_USER u
        ON REG_IDX = u.IDX
        LEFT JOIN TB_USER user
        ON UDT_IDX = user.IDX;
    </select>

    <select id="getSubList" resultType="getSubCategoryDto">
        select
        e.IDX,
        e.SUB_CATEGORY_NAME,
        e.USE_STATUS,
        e.REG_DATE,
        e.REG_IDX,
        e.UDT_DATE,
        e.UDT_IDX,
        u.NAME as regUserName,
        IFNULL(user.NAME,"없음") as udtUserName
        FROM TB_EXAM_SUB_CATEGORY e
        LEFT JOIN TB_USER u
        ON REG_IDX = u.IDX
        LEFT JOIN TB_USER user
        ON UDT_IDX = user.IDX;
    </select>

    <select id="getSubCategory" resultType="getSubCategoryDto">
        select
         IDX
        ,SUB_CATEGORY_NAME
        FROM TB_EXAM_SUB_CATEGORY
        WHERE MAIN_CATEGORY_IDX = #{mainIdx};
    </select>

    <select id="getSubDetail" resultType="getSubCategoryDto">
        SELECT E.IDX
        , E.USE_STATUS
        , E.REG_DATE
        , E.UDT_DATE
        , U.NAME AS REG_USER_NAME
        , IFNULL(USER.NAME,"수정 없음") AS UDT_USER_NAME
        , COUNT(TES.IDX) AS SUBJECT_COUNT
        , M.MAIN_CATEGORY_NAME
        , E.SUB_CATEGORY_NAME
        FROM TB_EXAM_SUB_CATEGORY E
        LEFT JOIN TB_USER U
        ON REG_IDX = U.IDX
        LEFT JOIN TB_USER USER
        ON UDT_IDX = USER.IDX
        LEFT JOIN TB_EXAM_MAIN_CATEGORY M
        ON MAIN_CATEGORY_IDX = M.IDX
        LEFT JOIN TB_EXAM_SUBJECT TES
        ON E.IDX = TES.SUB_CATEGORY_IDX
        WHERE E.IDX = #{idx};
    </select>

    <select id="getSubjectCategory" resultType="GetSubjectDto">
        SELECT
        IDX
        ,SUBJECT_NAME
        FROM TB_EXAM_SUBJECT
        WHERE SUB_CATEGORY_IDX = #{subIdx}
    </select>
</mapper>